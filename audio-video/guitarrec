#!/usr/bin/env bash

# my script for recording guitar amp output
# todo globalize pactl and pulse commands

record() {
		# pactl list short modules
		pactl unload-module module-loopback
		# pactl list short sources / pactl list short sinks
		pactl load-module module-loopback latency_msec=15 source=3 sink=1
		ffmpeg -f pulse -i 3 "$HOME/guitar_$(date '+%a__%b%d__%H_%M_%S').wav" &
		echo $! > /tmp/guitarpid
		echo "Rec ðŸŽ¸â€¢" > /tmp/recordingicon && pkill -RTMIN+3 dwmblocks
		fyi -t 500 -H "string:bgcolor:#a3be8c" "Recording guitar..."
}

end() {
		kill -15 "$(cat /tmp/guitarpid)" && rm -f /tmp/guitarpid
		pactl unload-module module-loopback
		echo "" > /tmp/recordingicon && pkill -RTMIN+3 dwmblocks
		fyi -t 500 -H "string:bgcolor:#bf616a" "Guitar recording ended."
}

# If the recording pid exists, end recording. If not, start recording
([[ -f /tmp/guitarpid ]] && end && exit 0) || record
